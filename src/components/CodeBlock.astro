---
import fs from "fs";
import path from "path";
import fm from "front-matter";
import { joinToProjectRoot } from "../utilities/server";
import { getShikiHighlighter } from "../utilities/shiki";
import { Square2Stack, Checkmark } from "../assets/icons";

type Tab = {
  bash?: string;
  copyable?: boolean;
  filename: string;
  code: string;
  language: string;
  class: string;
};

type Props = {
  tabs: Array<Tab | string>;
};

type TabData = {
  class: string;
  filename: string;
  code: string;
  language: string;
  copyable: boolean;
  bash?: string;
};

type RenderedTab = TabData & {
  codeHtml: string;
  bashHtml?: string;
};

function readTab(tab: Tab | string): TabData {
  if (typeof tab === "string") {
    const filepath = joinToProjectRoot("snippets", tab);
    const src = fs.readFileSync(filepath, "utf-8");
    const ext = path.extname(tab).replace(".", "");

    if (fm.test(src)) {
      type Attributes = { class?: string; filename?: string; language?: string; bash?: string; copyable?: boolean };
      const { attributes, body } = fm(src);
      return {
        class: attributes.class ?? "",
        bash: attributes.bash,
        filename: attributes.filename,
        code: body,
        language: attributes.language ?? ext,
        copyable: attributes.copyable ?? false,
      };
    }

    return { filename: path.basename(tab), code: src, language: ext, copyable: false, class: "" };
  } else {
    if (!tab.filename || !tab.code || !tab.language) {
      throw new Error("Missing filename, code, or language");
    }

    return {
      class: tab.class ?? "",
      filename: tab.filename,
      code: tab.code,
      language: tab.language,
      copyable: tab.copyable ?? false,
    };
  }
}

const { tabs } = Astro.props;

const highlighter = await getShikiHighlighter();
const renderedTabs: RenderedTab[] = await Promise.all(
  tabs.map(async (tab) => {
    const data = readTab(tab);
    const codeHtml = await highlighter.codeToHtml(data.code.trim(), data.language, {
      attributes: { class: "code-tabs-pre" },
    });
    const bashHtml = data.bash
      ? await highlighter.codeToHtml(`$ ${data.bash.trim()}`, "bash", {
          attributes: { class: "code-tabs-pre code-tabs-pre--bash" },
        })
      : undefined;

    return {
      ...data,
      codeHtml,
      bashHtml,
    };
  }),
);
---

<div class="code-tabs-container not-prose">
  <div
    class="scrollbar-hidden flex max-w-full flex-row divide-x divide-slate-800 overflow-x-scroll rounded-t-lg border-b border-slate-800 bg-slate-900"
  >
    {
      renderedTabs.map((tab) => (
        <div
          data-filename={tab.filename}
          class:list={["code-tabs-container__tab", { "no-underline": renderedTabs.length === 1 }]}
        >
          {tab.filename}
        </div>
      ))
    }
  </div>
  <>
    {
      renderedTabs.map((tab) => {
        const { class: cls, copyable, bashHtml, filename, codeHtml, code } = tab;
        return (
          <div class="code-tabs-container__code-container" data-filename={filename}>
            {bashHtml && (
              <div>
                <Fragment set:html={bashHtml} />
                <div class="code-tabs-container__output">
                  <hr class="code-tabs-container__output-rule code-tabs-container__output-rule--short" />
                  <span class="code-tabs-container__output-label">Output</span>
                  <hr class="code-tabs-container__output-rule code-tabs-container__output-rule--long" />
                </div>
              </div>
            )}
            <div class:list={[cls, { "code-rounded-b-lg": true, "code-tabs-container__output-code": !!bashHtml }]}>
              {!bashHtml && copyable && (
                <button data-code-copy-button data-code-copy-content={code} class="code-tabs-container__copy-button">
                  <Square2Stack class="code-tabs-container__copy-button__clipboard" />
                  <Checkmark class="code-tabs-container__copy-button__checkmark" />
                </button>
              )}
              <Fragment set:html={codeHtml} />
            </div>
          </div>
        );
      })
    }
  </>
</div>

<script>
  document.querySelectorAll(".code-tabs-container").forEach((container) => {
    const tabs = container.querySelectorAll(".code-tabs-container__tab");

    function selectTab(name: string): void {
      tabs.forEach((tab) => {
        if (tab.dataset.filename !== name) {
          tab.classList.remove("code-tabs-container__tab--selected");
        } else {
          tab.classList.add("code-tabs-container__tab--selected");
        }
      });

      container.querySelectorAll(".code-tabs-container__code-container").forEach((codeContainer) => {
        if (codeContainer.dataset.filename !== name) {
          codeContainer.classList.add("code-tabs-container__code-container--hidden");
        } else {
          codeContainer.classList.remove("code-tabs-container__code-container--hidden");
        }
      });
    }

    tabs.forEach((element) => {
      element.addEventListener("click", () => {
        const filename = element.dataset.filename;
        selectTab(filename);
      });
    });

    selectTab(tabs[0].dataset.filename);
  });

  const copyButtons = document.querySelectorAll("[data-code-copy-button]") as NodeListOf<HTMLButtonElement>;
  copyButtons.forEach((b: HTMLButtonElement) => {
    b.addEventListener("click", (e) => {
      try {
        const code = b.dataset.codeCopyContent;
        navigator.clipboard.writeText(code.trim());

        b.classList.toggle("code-tabs-container__copy-button--selected", true);

        setTimeout(() => {
          b.classList.toggle("code-tabs-container__copy-button--selected", false);
        }, 2000);
      } catch (e) {
        console.error(e);
      }
    });
  });
</script>
